<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>izo_1026_logP – initial_model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">izo_1026_logP</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data.html" rel="" target="">
 <span class="menu-text">Data</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./methods.html" rel="" target="">
 <span class="menu-text">Methods</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./initial_model.html" rel="" target="" aria-current="page">
 <span class="menu-text">Initial model</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./model_1.html" rel="" target="">
 <span class="menu-text">Model 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./model_2.html" rel="" target="">
 <span class="menu-text">Model 2</span></a>
  </li>  
  <li class="dropdown-header">
 <span class="menu-text">comparison.qmd</span></li>
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#initial-model" id="toc-initial-model" class="nav-link active" data-scroll-target="#initial-model">Initial model</a>
  <ul class="collapse">
  <li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors">Priors</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a></li>
  <li><a href="#summary-of-model-parameters" id="toc-summary-of-model-parameters" class="nav-link" data-scroll-target="#summary-of-model-parameters">Summary of model parameters</a></li>
  <li><a href="#goodness-of-fit" id="toc-goodness-of-fit" class="nav-link" data-scroll-target="#goodness-of-fit">Goodness of fit</a>
  <ul class="collapse">
  <li><a href="#analysis-of-etas" id="toc-analysis-of-etas" class="nav-link" data-scroll-target="#analysis-of-etas">Analysis of eta’s</a></li>
  <li><a href="#waic" id="toc-waic" class="nav-link" data-scroll-target="#waic">WAIC</a></li>
  </ul></li>
  <li><a href="#predictions" id="toc-predictions" class="nav-link" data-scroll-target="#predictions">Predictions</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><div class="quarto-title-block"><div class="quarto-title-tools-only"><h1></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>



<section id="initial-model" class="level1">
<h1>Initial model</h1>
<p>At the beginning we used a model with partial pooling and a common distribution for analyte-specific parameters. The second level of model is expressed as follows: <span class="math display">\[\begin{align*}
R_i \sim \text{MST}(\nu,\theta_R + \beta \cdot log P_i, \Omega) ,
\end{align*}\]</span> where <span class="math inline">\(R_i=(\log k_{w_i}, \log k_{a_i}, \log S_{2_i})\)</span> is a vector of analyte-specific chromatographic parameters, MST is a multivariate Student’s <span class="math inline">\(t\)</span>-distribution, <span class="math inline">\(\theta_R\)</span> is a vector of the expected values of <span class="math inline">\(R_i\)</span> for the analyte with <span class="math inline">\(\log P_i = 0\)</span>, and <span class="math inline">\(\beta\)</span> is a vector of slopes between <span class="math inline">\(\log P_i\)</span> and <span class="math inline">\(R_i\)</span>. In turn, <span class="math inline">\(\Omega\)</span> is the covariance matrix for the random effects related to the residual and unexplained between-analyte variability. The MST distribution with <span class="math inline">\(\nu\)</span> was used to ensure flexibility and robustness for analytes with unusually high or low values of <span class="math inline">\(R_i\)</span>.</p>
<section id="priors" class="level2">
<h2 class="anchored" data-anchor-id="priors">Priors</h2>
<p>In this work were used weakly uninformative priors as described in our previous work <span class="citation" data-cites="Kubik2018">(<a href="#ref-Kubik2018" role="doc-biblioref">Kubik, Kaliszan, and Wiczling 2018</a>)</span>: <span class="math display">\[\begin{align*}
\nu \sim Gamma(2,0.1),\\
\theta_{\log k_{w}} \sim N(2,5),  \quad \theta_{\log k_{a}} \sim N(0,5),\\
\theta_{\log S_{2}},  \sim N(\log 2,0.5), \\
\beta_{\log k_{w}} \sim N(1,0.5), \quad
\beta_{\log k_{a}} \sim N(1,0.5), \\
\text{logPmissing} \sim N(2.56,1.92), \\
\omega \sim N(0,5),\\
\begin{bmatrix}
1 &amp; \rho_{1,2} &amp; \rho_{1,3} \\
\rho_{2,1} &amp; 1 &amp; \rho_{2,3} \\
\rho_{3,1} &amp; \rho_{3,2} &amp; 1
\end{bmatrix} \sim LKJ(1), \\
\sigma \sim N(0,1),\\
\eta \sim MST(\nu,\theta_{\eta},\Omega).
\end{align*}\]</span></p>
</section>
<section id="analysis" class="level2">
<h2 class="anchored" data-anchor-id="analysis">Analysis</h2>
<p>At the beginning, a model was constructed and implemented in the Stan program.</p>
<div class="cell" data-output.var="initial_model">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode stan code-with-copy"><code class="sourceCode stan"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">functions</span>{</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> hplcmodel(<span class="dt">real</span> fi, <span class="dt">real</span> logkw, <span class="dt">real</span> logka, <span class="dt">real</span> logS2A){</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">real</span> logk;                                              <span class="co">// retention factor</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">real</span> S1;                                                <span class="co">// slope coefficient</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    S1 = (logkw - logka)*(<span class="dv">1</span>+exp(logS2A));</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    logk                    = logkw - S1 * fi / (<span class="dv">1</span> + exp(logS2A) * fi);</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> logk;</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span>{</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> nAnalytes;                                            <span class="co">// number of analytes</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> nObs;                                             <span class="co">// number of observations</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> analyte[nObs];                                        <span class="co">// analytes indexes</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[nObs] logkObs;                                 <span class="co">// observed retention factors</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[nObs] fi;                                      <span class="co">// organic modifier content in the mobile phase</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logP[nAnalytes];      </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> idxmissing[nAnalytes];</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> nfiplot;                                          <span class="co">// number of fi for plotting</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[nfiplot] fiplot;                                   <span class="co">// organic modifier content in the mobile phase</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>, <span class="kw">upper</span> = <span class="dv">1</span>&gt; run_estimation; <span class="co">// 0 for prior predictive, 1 for estimation</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed data</span>{</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[<span class="dv">3</span>] etaHat;</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  etaHat                    = rep_vector(<span class="fl">0.0</span>,<span class="dv">3</span>);</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="kw">parameters</span>{</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkaHat;                                           <span class="co">// retention factor in acetonitrile for  analyte with MLOGP 0</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logS2AHat;                                          <span class="co">// mean curvature coefficient for acetonitrile in population</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt; sigmaadd;                            <span class="co">// standard deviation for residuals</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">corr_matrix</span>[<span class="dv">3</span>] rho;                                      <span class="co">// correlation matrix</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>&lt;<span class="kw">lower</span> = <span class="dv">0</span>&gt;[<span class="dv">3</span>] omega;                              <span class="co">// diagonal elements of variance-covariance matrix</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkwHat;                                           <span class="co">// mean value of logkw in population</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[<span class="dv">3</span>] eta[nAnalytes];                            <span class="co">// inter-individual variability</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta_logkw;                                     <span class="co">// coefficient value for molecular descriptor</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> beta_logka;</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> nu;          <span class="co">// normality constant</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logPmissing[nAnalytes];</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="kw">transformed parameters</span>{</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">cov_matrix</span>[<span class="dv">3</span>] Omega;                                  <span class="co">// variance-covariance matrix</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logka[nAnalytes];                                    <span class="co">// slope coefficient for acetonitrile</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logS2A[nAnalytes];                                   <span class="co">// curvature coefficient for acetonitrile</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkw[nAnalytes];                                    <span class="co">// retention factor in neat water</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[nObs] logkHat;                                 <span class="co">// mean value of logk in population</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  Omega = quad_form_diag(rho, omega);   <span class="co">// diag_matrix(omega) * rho * diag_matrix(omega)</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span>:nAnalytes){</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    logka[j]  = eta[j, <span class="dv">1</span>] + logkaHat + beta_logka * ((<span class="dv">1</span>-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    logS2A[j] = eta[j, <span class="dv">2</span>] + logS2AHat;</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>    logkw[j]  = eta[j, <span class="dv">3</span>] + logkwHat + beta_logkw * ((<span class="dv">1</span>-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:nObs){</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    logkHat[i] = hplcmodel(fi[i], logkw[analyte[i]], logka[analyte[i]], logS2A[analyte[i]]);</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="kw">model</span>{</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  logkwHat              ~ normal(<span class="dv">2</span>, <span class="dv">5</span>);</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  logkaHat              ~ normal(<span class="dv">0</span>, <span class="dv">5</span>);</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  logS2AHat             ~ normal(log(<span class="dv">2</span>), <span class="fl">0.5</span>);</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    beta_logkw              ~ normal(<span class="dv">1</span>,<span class="fl">0.5</span>);</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    beta_logka              ~ normal(<span class="dv">1</span>,<span class="fl">0.5</span>);</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  logPmissing ~ normal(<span class="fl">2.56</span>,<span class="fl">1.92</span>);</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  omega                 ~ normal(<span class="dv">0</span>,<span class="dv">5</span>);</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  nu                      ~ gamma(<span class="dv">2</span>,<span class="fl">0.1</span>);</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  rho                       ~ lkj_corr(<span class="dv">1</span>);</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  sigmaadd              ~ normal(<span class="dv">0</span>,<span class="dv">1</span>);</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  eta                       ~ multi_student_t(nu,etaHat, Omega);    <span class="co">// inter-individual variability</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(run_estimation==<span class="dv">1</span>){</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  logkObs                   ~ normal(logkHat, sigmaadd);    <span class="co">// observations</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="kw">generated quantities</span>{</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[<span class="dv">3</span>] etaPred[nAnalytes];                         <span class="co">// etas</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkaPred[nAnalytes];                                <span class="co">// etention factor in acetonitrile</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logS2APred[nAnalytes];                               <span class="co">// curvature coefficient for acetonitrile</span></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkwPred[nAnalytes];                                <span class="co">// retention factor in neat water</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  <span class="dt">vector</span>[nObs] logkHatPred;                             <span class="co">// predicted logk   </span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkCond[nObs];</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> logkPred[nObs];</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> log_lik[nObs];</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  <span class="dt">real</span> log_likPred[nObs];</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[nAnalytes,nfiplot] logkHatPlotACond;</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[nAnalytes,nfiplot] logkPlotACond;</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[nAnalytes,nfiplot] logkHatPlotAPred;</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  <span class="dt">matrix</span>[nAnalytes,nfiplot] logkPlotAPred;</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span>:nAnalytes){</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    etaPred[j] = multi_student_t_rng(nu,etaHat, Omega); <span class="co">// inter-individual variability</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    logkaPred[j] = etaPred[j, <span class="dv">1</span>] + logkaHat + beta_logka * ((<span class="dv">1</span>-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    logS2APred[j]   = etaPred[j, <span class="dv">2</span>] + logS2AHat;</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>    logkwPred[j]    = etaPred[j, <span class="dv">3</span>] + logkwHat + beta_logkw * ((<span class="dv">1</span>-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span>:nObs){</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>    logkHatPred[i]  = hplcmodel(fi[i], logkwPred[analyte[i]], logkaPred[analyte[i]], logS2APred[analyte[i]]);</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>    logkCond[i]     = normal_rng(logkHat[i], sigmaadd);</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>    logkPred[i]     = normal_rng(logkHatPred[i], sigmaadd);</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    log_lik[i]      = normal_lpdf(logkObs[i] | logkHat[i], sigmaadd);</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    log_likPred[i]  = normal_lpdf(logkObs[i] | logkHatPred[i], sigmaadd);</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span>:nAnalytes){</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(z <span class="cf">in</span> <span class="dv">1</span>:nfiplot){</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>      logkHatPlotACond[j,z] = hplcmodel(fiplot[z], logkw[j], logka[j], logS2A[j]);</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>      logkPlotACond[j,z]        = normal_rng(logkHatPlotACond[j,z], sigmaadd);</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>      logkHatPlotAPred[j,z] = hplcmodel(fiplot[z], logkwPred[j], logkaPred[j], logS2APred[j]);</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>      logkPlotAPred[j,z]        = normal_rng(logkHatPlotAPred[j,z], sigmaadd);</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Then, the data was added to it and the initial values of the model parameters were determined. In the end, the model was fitted.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># indicating missing value of log P</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>idxmissing <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">1026</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>idxmiss <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.nan</span>(DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)]))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>idxmissing[idxmiss] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>DS<span class="sc">$</span>logP_ACD[<span class="fu">which</span>(DS<span class="sc">$</span>ID <span class="sc">%in%</span> idxmiss)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># data to model</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>datastruct_prior <span class="ot">=</span> <span class="fu">with</span>(DS,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">logP=</span>DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)],</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idxmissing=</span>idxmissing,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes=</span>nAnalytes,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nObs=</span>nObs,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">analyte=</span>DS<span class="sc">$</span>ID,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logkObs=</span>DS<span class="sc">$</span>logk, </span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fi=</span>DS<span class="sc">$</span>concentration,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfiplot=</span><span class="fu">length</span>(fi),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fiplot=</span>fi,</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_estimation=</span><span class="dv">0</span>))</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>datastruct <span class="ot">=</span> <span class="fu">with</span>(DS,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">list</span>(<span class="at">logP=</span>DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)],</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idxmissing=</span>idxmissing,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes=</span>nAnalytes,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nObs=</span>nObs,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">analyte=</span>DS<span class="sc">$</span>ID,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logkObs=</span>DS<span class="sc">$</span>logk, </span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fi=</span>DS<span class="sc">$</span>concentration,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfiplot=</span><span class="fu">length</span>(fi),</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fiplot=</span>fi,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_estimation=</span><span class="dv">1</span>))</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co"># declaring initial values for each variable in chains</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">logkwHat  =</span> <span class="fu">mean</span>(inital_param_A[,<span class="dv">2</span>]<span class="sc">+</span><span class="fu">rnorm</span>(nAnalytes,<span class="dv">0</span>,<span class="fl">0.5</span>)),</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">logkaHat  =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">logS2AHat =</span> <span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_logka =</span> <span class="fl">0.4</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>),</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_logkw =</span> <span class="fl">0.8</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>),</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">eta=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(nAnalytes<span class="sc">*</span><span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),nAnalytes,<span class="dv">3</span>),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>       <span class="at">rho =</span> <span class="fu">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>       <span class="at">nu =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="dv">10</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">2</span>)),</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>       <span class="at">omega=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.2</span>)),</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>       <span class="at">sigmaadd =</span> <span class="fl">0.2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a><span class="co"># specifying parameters to analysis </span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>parametersToPlot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"eta"</span>,<span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>)</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>otherRVs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"logkCond"</span>,<span class="st">"logkPred"</span>,<span class="st">"logkPlotACond"</span>,<span class="st">"logkPlotAPred"</span>,<span class="st">"log_lik"</span>,<span class="st">"log_likPred"</span>,</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>              <span class="st">"eta"</span>,<span class="st">"etaPred"</span>)</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(parametersToPlot, otherRVs)</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>parametersToPlot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lp__"</span>, parametersToPlot)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting model</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>fit_prior <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">file=</span><span class="st">"HPLCizomodel44.stan"</span>,</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>datastruct_prior,</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>            <span class="at">pars=</span>parameters,</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">iter=</span><span class="dv">2000</span>,</span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>            <span class="at">warmup=</span><span class="dv">1000</span>,</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>            <span class="at">init=</span>init,</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>            <span class="at">chains=</span><span class="dv">4</span>,<span class="at">thin=</span><span class="dv">1</span>,<span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.9</span>,<span class="at">max_treedepth=</span><span class="dv">15</span>))</span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">file=</span><span class="st">"ACN000.stan"</span>,</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>datastruct,</span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>                   <span class="at">pars=</span>parameters,</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>                   <span class="at">iter=</span><span class="dv">2000</span>,</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>                   <span class="at">warmup=</span><span class="dv">1000</span>,</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>                   <span class="at">init=</span>init,</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>                   <span class="at">chains=</span><span class="dv">4</span>,<span class="at">thin=</span><span class="dv">1</span>,<span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth=</span><span class="dv">12</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Below code preapering data to fit the model in supercomputer:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># load data</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>DS       <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"1_data/database_stan_1026.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">dec =</span> <span class="st">"."</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>DS_names <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"1_data/database_stan_1026_analyte_names.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">dec =</span> <span class="st">"."</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>DS_pKa   <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"1_data/ACD_pKas.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">dec =</span> <span class="st">"."</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>idxmissing <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">1026</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>idxmiss <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.nan</span>(DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)]))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>idxmissing[idxmiss] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>DS<span class="sc">$</span>logP_ACD[<span class="fu">which</span>(DS<span class="sc">$</span>ID <span class="sc">%in%</span> idxmiss)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>logP<span class="ot">=</span>DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>nAnalytes<span class="ot">=</span><span class="fu">length</span>(<span class="fu">unique</span>(DS<span class="sc">$</span>ID))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>nObs<span class="ot">=</span><span class="fu">length</span>(DS<span class="sc">$</span>ID)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>analyte<span class="ot">=</span>DS<span class="sc">$</span>ID</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>logkObs<span class="ot">=</span>DS<span class="sc">$</span>logk</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>fi<span class="ot">=</span>DS<span class="sc">$</span>concentration</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>fiplot<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.1</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>nfiplot<span class="ot">=</span><span class="fu">length</span>(fiplot)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>run_estimation<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_rdump</span>(<span class="fu">c</span>(<span class="st">"logP"</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>             <span class="st">"nAnalytes"</span>, </span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>             <span class="st">"nObs"</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>             <span class="st">"idxmissing"</span>, </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>             <span class="st">"analyte"</span>, </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>             <span class="st">"logkObs"</span>, </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>             <span class="st">"fi"</span>,</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>             <span class="st">"nfiplot"</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>             <span class="st">"fiplot"</span>,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>             <span class="st">"run_estimation"</span>),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>           <span class="at">file=</span><span class="st">"2_initial_model/model.data.R"</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>inital_param_A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,nAnalytes,<span class="dv">2</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nAnalytes){</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>  inital_param_A[i,] <span class="ot">=</span> </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">polyfit</span>(DS<span class="sc">$</span>concentration[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>DS<span class="sc">$</span>concentration[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]),</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>            DS<span class="sc">$</span>logk[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)],<span class="dv">1</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>  logkwHat  <span class="ot">=</span>  <span class="fu">mean</span>(inital_param_A[,<span class="dv">2</span>]<span class="sc">+</span><span class="fu">rnorm</span>(nAnalytes,<span class="dv">0</span>,<span class="fl">0.5</span>))</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  logkaHat  <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  logS2AHat <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>  beta_logka <span class="ot">=</span> <span class="fl">0.4</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>  beta_logkw <span class="ot">=</span> <span class="fl">0.8</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>  eta<span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(nAnalytes<span class="sc">*</span><span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),nAnalytes,<span class="dv">3</span>)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>  rho <span class="ot">=</span> <span class="fu">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>  nu <span class="ot">=</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="dv">10</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">2</span>))</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>  omega<span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  sigmaadd <span class="ot">=</span> <span class="fl">0.2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_rdump</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"eta"</span>,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>               <span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>),</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>             <span class="at">file=</span><span class="fu">paste</span>(<span class="st">"2_initial_model/model_"</span>, i, <span class="st">".init.R"</span>, <span class="at">sep=</span><span class="st">""</span>))</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="summary-of-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-model-parameters">Summary of model parameters</h2>
<p>Code for print summary of parameters from supercomputer:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as_cmdstan_fit</span>(<span class="fu">c</span>(<span class="st">'2_initial_model/output_1.csv'</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_2.csv'</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_3.csv'</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_4.csv'</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_5.csv'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_6.csv'</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_7.csv'</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_8.csv'</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_9.csv'</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_10.csv'</span>))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span><span class="fu">print</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>), <span class="at">max_rows =</span> <span class="dv">26</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Code for print summary of parameters from computer:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"2_initial_model/Fit.Rsave"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"2_initial_model/Fit_sample.Rsave"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit,<span class="at">pars=</span><span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: HPLCizomodel44.
4 chains, each with iter=2000; warmup=1000; thin=1; 
post-warmup draws per chain=1000, total post-warmup draws=4000.

            mean se_mean   sd  2.5%   25%   50%   75% 97.5% n_eff Rhat
logkwHat    1.70    0.01 0.10  1.52  1.63  1.70  1.77  1.89    98 1.05
logkaHat   -1.99    0.01 0.06 -2.11 -2.04 -1.99 -1.95 -1.87    91 1.09
logS2AHat   1.06    0.00 0.02  1.02  1.04  1.06  1.07  1.09   545 1.01
beta_logka  0.25    0.00 0.02  0.21  0.24  0.25  0.26  0.29   124 1.03
beta_logkw  0.97    0.00 0.03  0.90  0.94  0.97  0.99  1.03   201 1.02
rho[1,1]    1.00     NaN 0.00  1.00  1.00  1.00  1.00  1.00   NaN  NaN
rho[1,2]    0.29    0.00 0.04  0.21  0.26  0.29  0.32  0.36  1572 1.00
rho[1,3]    0.54    0.00 0.03  0.49  0.52  0.54  0.56  0.59  4342 1.00
rho[2,1]    0.29    0.00 0.04  0.21  0.26  0.29  0.32  0.36  1572 1.00
rho[2,2]    1.00    0.00 0.00  1.00  1.00  1.00  1.00  1.00  3956 1.00
rho[2,3]    0.35    0.00 0.04  0.27  0.32  0.35  0.38  0.42  1662 1.00
rho[3,1]    0.54    0.00 0.03  0.49  0.52  0.54  0.56  0.59  4342 1.00
rho[3,2]    0.35    0.00 0.04  0.27  0.32  0.35  0.38  0.42  1662 1.00
rho[3,3]    1.00    0.00 0.00  1.00  1.00  1.00  1.00  1.00   780 1.00
nu          5.01    0.03 0.56  4.05  4.62  4.96  5.35  6.25   474 1.01
omega[1]    0.93    0.00 0.03  0.88  0.91  0.93  0.95  0.99   891 1.01
omega[2]    0.43    0.00 0.02  0.40  0.42  0.43  0.45  0.47  1436 1.00
omega[3]    1.43    0.00 0.05  1.33  1.39  1.43  1.46  1.53  1262 1.00
sigmaadd    0.04    0.00 0.00  0.04  0.04  0.04  0.04  0.04  1429 1.00

Samples were drawn using NUTS(diag_e) at Sun Mar 22 03:24:00 2020.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
</section>
<section id="goodness-of-fit" class="level2">
<h2 class="anchored" data-anchor-id="goodness-of-fit">Goodness of fit</h2>
<p>The graphs below were used to check how well the model fits the set of observations. The one on the left compares individual predictions with actual observations. The one on the right shows population predictions with actual observations.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(fit_sample<span class="sc">$</span>logkCond,<span class="dv">2</span>,mean),DS<span class="sc">$</span>logk,<span class="at">cex.lab=</span><span class="fl">1.2</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>),<span class="at">pch=</span><span class="dv">20</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Obs]),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Pred]))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(fit_sample<span class="sc">$</span>logkPred,<span class="dv">2</span>,mean),DS<span class="sc">$</span>logk,<span class="at">cex.lab=</span><span class="fl">1.2</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>),<span class="at">pch=</span><span class="dv">20</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Obs]),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Pred]))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="at">lwd=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="initial_model_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="analysis-of-etas" class="level3">
<h3 class="anchored" data-anchor-id="analysis-of-etas">Analysis of eta’s</h3>
<p>Intra-analyte residues for analyte-specific parameters were also determined and are shown below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>eta_logka <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>eta[,,<span class="dv">1</span>]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> mean)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>eta_logS2A <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>eta[,,<span class="dv">2</span>]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> mean)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>eta_logkw <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>eta[,,<span class="dv">3</span>]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> mean)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>DS_corr <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(eta_logka,eta_logS2A,eta_logkw))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(DS_corr, </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span>  <span class="fu">c</span>(<span class="st">"eta_logkw"</span>,<span class="st">"eta_logka"</span>,<span class="st">"eta_logS2A"</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower=</span><span class="fu">list</span>(<span class="at">continuous=</span><span class="st">'points'</span>), </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">columnLabels =</span> <span class="fu">c</span>(<span class="st">"eta[ logk[w]]"</span>,<span class="st">"eta[ logk[a]]"</span>,<span class="st">"eta[ logS[2]]"</span>),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> label_parsed,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">diag=</span><span class="fu">list</span>(<span class="at">continuous=</span><span class="fu">wrap</span>(<span class="st">"barDiag"</span>, <span class="at">fill=</span><span class="st">"darkblue"</span>))</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>)<span class="sc">+</span> <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="initial_model_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The plot shows that the distribution of residuals in the case of the <span class="math inline">\(\log k_a\)</span> parameter is bimodal. It indicates that analytes with a similar log P are grouped into two clusters.</p>
</section>
<section id="waic" class="level3">
<h3 class="anchored" data-anchor-id="waic">WAIC</h3>
<p>WAIC was also used to evaluate the model. This parameter estimates the effective number of parameters to adjust for overfitting.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">waic</span>(<span class="fu">extract_log_lik</span>(fit)) <span class="co"># waic(fit_sample$log_lik)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 
1417 (27.8%) p_waic estimates greater than 0.4. We recommend trying loo instead.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 5097 log-likelihood matrix

          Estimate    SE
elpd_waic   7819.9  97.3
p_waic      1961.6  56.0
waic      -15639.9 194.6

1417 (27.8%) p_waic estimates greater than 0.4. We recommend trying loo instead. </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(<span class="fu">extract_log_lik</span>(fit))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Relative effective sample sizes ('r_eff' argument) not specified.
For models fit with MCMC, the reported PSIS effective sample sizes and 
MCSE estimates will be over-optimistic.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some Pareto k diagnostic values are too high. See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 4000 by 5097 log-likelihood matrix

         Estimate    SE
elpd_loo   7250.4 103.5
p_loo      2531.2  64.1
looic    -14500.8 206.9
------
Monte Carlo SE of elpd_loo is NA.

Pareto k diagnostic values:
                         Count Pct.    Min. n_eff
(-Inf, 0.5]   (good)     2491  48.9%   208       
 (0.5, 0.7]   (ok)       1116  21.9%   57        
   (0.7, 1]   (bad)      1236  24.2%   13        
   (1, Inf)   (very bad)  254   5.0%   2         
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
</div>
</section>
</section>
<section id="predictions" class="level2">
<h2 class="anchored" data-anchor-id="predictions">Predictions</h2>
<p>Individual predictions</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>nazwy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Caffeine"</span>,<span class="st">"Chlorpropamide"</span>,<span class="st">"Doxepin hydrochloride"</span>,<span class="st">"Perphenazine"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pindolol"</span>,<span class="st">"Phenylbutazone"</span>,<span class="st">"Procainamide hydrochloride"</span>,<span class="st">"Retinoic acid"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sulfaphenazole"</span>,<span class="st">"Tolbutamide"</span>,<span class="st">"Ketoprofen"</span>,<span class="st">"Indomethacin"</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>l_nazwy <span class="ot">&lt;-</span> <span class="fu">which</span>(DS_names<span class="sc">$</span>Analyte[<span class="sc">!</span><span class="fu">duplicated</span>(DS_names<span class="sc">$</span>ID)] <span class="sc">%in%</span> nazwy)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nAnalytes){</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>logkPlotACond[,i,]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> quantile, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  logk_prct <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">rep</span>(i,<span class="dv">11</span>),fiplot,<span class="fu">t</span>(l)))</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(logk_prct)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"ID"</span>,<span class="st">"concentration"</span>,<span class="st">"low"</span>,<span class="st">"median"</span>,<span class="st">"high"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  plots[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data=</span><span class="fu">subset</span>(DS, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> concentration, <span class="at">y =</span> logk), <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, <span class="at">y =</span> median), <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymin =</span> low, </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymax =</span> high), <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">fill=</span><span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">4</span>)) <span class="sc">+</span> </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(DS<span class="sc">$</span>Names[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]),</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>), <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)) </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>figure1 <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(<span class="at">plotlist =</span> plots[l_nazwy], <span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="fu">annotate_figure</span>(figure1,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">bottom =</span> <span class="fu">text_grob</span>(<span class="fu">expression</span>(varphi)),</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">left =</span> <span class="fu">text_grob</span>(<span class="st">"log k"</span>, <span class="at">rot =</span> <span class="dv">90</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="initial_model_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Population predictions</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nAnalytes){</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>logkPlotAPred[,i,]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> quantile, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  logk_prct <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">rep</span>(i,<span class="dv">11</span>),fiplot,<span class="fu">t</span>(l)))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(logk_prct)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"ID"</span>,<span class="st">"concentration"</span>,<span class="st">"low"</span>,<span class="st">"median"</span>,<span class="st">"high"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  plots[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data=</span><span class="fu">subset</span>(DS, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> concentration, <span class="at">y =</span> logk), <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, <span class="at">y =</span> median), <span class="at">col=</span><span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymin =</span> low, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymax =</span> high), <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">fill=</span><span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">4</span>)) <span class="sc">+</span> </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(DS<span class="sc">$</span>Names[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>), <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)) </span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>figure1 <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(<span class="at">plotlist =</span> plots[l_nazwy], <span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="fu">annotate_figure</span>(figure1,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">bottom =</span> <span class="fu">text_grob</span>(<span class="fu">expression</span>(varphi)),</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">left =</span> <span class="fu">text_grob</span>(<span class="st">"log k"</span>, <span class="at">rot =</span> <span class="dv">90</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="initial_model_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>


<!-- -->


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-Kubik2018" class="csl-entry" role="listitem">
Kubik, Łukasz, Roman Kaliszan, and Paweł Wiczling. 2018. <span>“<span class="nocase">Analysis of Isocratic-Chromatographic-Retention Data using Bayesian Multilevel Modeling</span>.”</span> <em>Analytical Chemistry</em> 90 (22): 13670–79. <a href="https://doi.org/10.1021/acs.analchem.8b04033">https://doi.org/10.1021/acs.analchem.8b04033</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Initial model</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>At the beginning we used a model with partial pooling and a common distribution for analyte-specific parameters. The second level of model is expressed as follows: \begin{align*}</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a> R_i \sim \text{MST}(\nu,\theta_R + \beta \cdot log P_i, \Omega) ,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>\end{align*} where $R_i=(\log k_{w_i}, \log k_{a_i}, \log S_{2_i})$ is a vector of analyte-specific chromatographic parameters, MST is a multivariate Student's $t$-distribution, $\theta_R$ is a vector of the expected values of $R_i$ for the analyte with $\log P_i = 0$, and $\beta$ is a vector of slopes between $\log P_i$ and $R_i$. In turn, $\Omega$ is the covariance matrix for the random effects related to the residual and unexplained between-analyte variability. The MST distribution with $\nu$ was used to ensure flexibility and robustness for analytes with unusually high or low values of $R_i$.</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Priors</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>In this work were used weakly uninformative priors as described in our previous work <span class="co">[</span><span class="ot">@Kubik2018</span><span class="co">]</span>: \begin{align*}</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>\nu \sim Gamma(2,0.1),<span class="sc">\\</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>\theta_{\log k_{w}} \sim N(2,5),  \quad \theta_{\log k_{a}} \sim N(0,5),<span class="sc">\\</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>\theta_{\log S_{2}},  \sim N(\log 2,0.5), <span class="sc">\\</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>\beta_{\log k_{w}} \sim N(1,0.5), \quad</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>\beta_{\log k_{a}} \sim N(1,0.5), <span class="sc">\\</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>\text{logPmissing} \sim N(2.56,1.92), <span class="sc">\\</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>\omega \sim N(0,5),<span class="sc">\\</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>\begin{bmatrix}</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a> 1 &amp; \rho_{1,2} &amp; \rho_{1,3} <span class="sc">\\</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a> \rho_{2,1} &amp; 1 &amp; \rho_{2,3} <span class="sc">\\</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a> \rho_{3,1} &amp; \rho_{3,2} &amp; 1 </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a> \end{bmatrix} \sim LKJ(1), <span class="sc">\\</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>\sigma \sim N(0,1),<span class="sc">\\</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>\eta \sim MST(\nu,\theta_{\eta},\Omega).</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>\end{align*}</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analysis</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>At the beginning, a model was constructed and implemented in the Stan program.</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="in">```{stan output.var="initial_model", eval = FALSE}</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="in">functions{</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="in">  real hplcmodel(real fi, real logkw, real logka, real logS2A){</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="in">    real logk;                                              // retention factor</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a><span class="in">    real S1;                                                // slope coefficient</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="in">    S1 = (logkw - logka)*(1+exp(logS2A));</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="in">    logk                    = logkw - S1 * fi / (1 + exp(logS2A) * fi);</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="in">    return logk;</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="in">data{</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a><span class="in">  int nAnalytes;                                            // number of analytes</span></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="in">  int nObs;                                             // number of observations</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="in">  int analyte[nObs];                                        // analytes indexes</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[nObs] logkObs;                                 // observed retention factors</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[nObs] fi;                                      // organic modifier content in the mobile phase</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="in">  real logP[nAnalytes];      </span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="in">  int idxmissing[nAnalytes];</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="in">  int nfiplot;                                          // number of fi for plotting</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[nfiplot] fiplot;                                   // organic modifier content in the mobile phase</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="in">  int&lt;lower = 0, upper = 1&gt; run_estimation; // 0 for prior predictive, 1 for estimation</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="in">transformed data{</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[3] etaHat;</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="in">  etaHat                    = rep_vector(0.0,3);</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="in">parameters{</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkaHat;                                           // retention factor in acetonitrile for  analyte with MLOGP 0</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a><span class="in">  real logS2AHat;                                          // mean curvature coefficient for acetonitrile in population</span></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="in">  real&lt;lower = 0&gt; sigmaadd;                            // standard deviation for residuals</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a><span class="in">  corr_matrix[3] rho;                                      // correlation matrix</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="in">  vector&lt;lower = 0&gt;[3] omega;                              // diagonal elements of variance-covariance matrix</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkwHat;                                           // mean value of logkw in population</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[3] eta[nAnalytes];                            // inter-individual variability</span></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a><span class="in">  real beta_logkw;                                     // coefficient value for molecular descriptor</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="in">  real beta_logka;</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a><span class="in">  real nu;          // normality constant</span></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="in">  real logPmissing[nAnalytes];</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a><span class="in">transformed parameters{</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a><span class="in">  cov_matrix[3] Omega;                                  // variance-covariance matrix</span></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a><span class="in">  real logka[nAnalytes];                                    // slope coefficient for acetonitrile</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="in">  real logS2A[nAnalytes];                                   // curvature coefficient for acetonitrile</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkw[nAnalytes];                                    // retention factor in neat water</span></span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[nObs] logkHat;                                 // mean value of logk in population</span></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="in">  Omega = quad_form_diag(rho, omega);   // diag_matrix(omega) * rho * diag_matrix(omega)</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a><span class="in">  for(j in 1:nAnalytes){</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a><span class="in">    logka[j]  = eta[j, 1] + logkaHat + beta_logka * ((1-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a><span class="in">    logS2A[j] = eta[j, 2] + logS2AHat;</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="in">    logkw[j]  = eta[j, 3] + logkwHat + beta_logkw * ((1-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a><span class="in">  for(i in 1:nObs){</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a><span class="in">    logkHat[i] = hplcmodel(fi[i], logkw[analyte[i]], logka[analyte[i]], logS2A[analyte[i]]);</span></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a><span class="in">model{</span></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a><span class="in">  logkwHat              ~ normal(2, 5);</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a><span class="in">  logkaHat              ~ normal(0, 5);</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a><span class="in">  logS2AHat             ~ normal(log(2), 0.5);</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a><span class="in">    beta_logkw              ~ normal(1,0.5);</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="in">    beta_logka              ~ normal(1,0.5);</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="in">  logPmissing ~ normal(2.56,1.92);</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="in">  omega                 ~ normal(0,5);</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a><span class="in">  nu                      ~ gamma(2,0.1);</span></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a><span class="in">  rho                       ~ lkj_corr(1);</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="in">  sigmaadd              ~ normal(0,1);</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a><span class="in">  eta                       ~ multi_student_t(nu,etaHat, Omega);    // inter-individual variability</span></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a><span class="in">  if(run_estimation==1){</span></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a><span class="in">  logkObs                   ~ normal(logkHat, sigmaadd);    // observations</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="in">generated quantities{</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[3] etaPred[nAnalytes];                         // etas</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkaPred[nAnalytes];                                // etention factor in acetonitrile</span></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a><span class="in">  real logS2APred[nAnalytes];                               // curvature coefficient for acetonitrile</span></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkwPred[nAnalytes];                                // retention factor in neat water</span></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a><span class="in">  vector[nObs] logkHatPred;                             // predicted logk   </span></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkCond[nObs];</span></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a><span class="in">  real logkPred[nObs];</span></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a><span class="in">  real log_lik[nObs];</span></span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a><span class="in">  real log_likPred[nObs];</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[nAnalytes,nfiplot] logkHatPlotACond;</span></span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[nAnalytes,nfiplot] logkPlotACond;</span></span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[nAnalytes,nfiplot] logkHatPlotAPred;</span></span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a><span class="in">  matrix[nAnalytes,nfiplot] logkPlotAPred;</span></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a><span class="in">  for(j in 1:nAnalytes){</span></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a><span class="in">    etaPred[j] = multi_student_t_rng(nu,etaHat, Omega); // inter-individual variability</span></span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a><span class="in">    logkaPred[j] = etaPred[j, 1] + logkaHat + beta_logka * ((1-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span></span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a><span class="in">    logS2APred[j]   = etaPred[j, 2] + logS2AHat;</span></span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a><span class="in">    logkwPred[j]    = etaPred[j, 3] + logkwHat + beta_logkw * ((1-idxmissing[j])*logP[j]+idxmissing[j]*logPmissing[j]);</span></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a><span class="in">  for(i in 1:nObs){</span></span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a><span class="in">    logkHatPred[i]  = hplcmodel(fi[i], logkwPred[analyte[i]], logkaPred[analyte[i]], logS2APred[analyte[i]]);</span></span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a><span class="in">    logkCond[i]     = normal_rng(logkHat[i], sigmaadd);</span></span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a><span class="in">    logkPred[i]     = normal_rng(logkHatPred[i], sigmaadd);</span></span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a><span class="in">    log_lik[i]      = normal_lpdf(logkObs[i] | logkHat[i], sigmaadd);</span></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a><span class="in">    log_likPred[i]  = normal_lpdf(logkObs[i] | logkHatPred[i], sigmaadd);</span></span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a><span class="in">  for(j in 1:nAnalytes){</span></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a><span class="in">    for(z in 1:nfiplot){</span></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a><span class="in">      logkHatPlotACond[j,z] = hplcmodel(fiplot[z], logkw[j], logka[j], logS2A[j]);</span></span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a><span class="in">      logkPlotACond[j,z]        = normal_rng(logkHatPlotACond[j,z], sigmaadd);</span></span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a><span class="in">      logkHatPlotAPred[j,z] = hplcmodel(fiplot[z], logkwPred[j], logkaPred[j], logS2APred[j]);</span></span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a><span class="in">      logkPlotAPred[j,z]        = normal_rng(logkHatPlotAPred[j,z], sigmaadd);</span></span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a><span class="in">      </span></span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>Then, the data was added to it and the initial values of the model parameters were determined. In the end, the model was fitted.</span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval = FALSE}</span></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a><span class="co"># indicating missing value of log P</span></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>idxmissing <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">1026</span>)</span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>idxmiss <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.nan</span>(DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)]))</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a>idxmissing[idxmiss] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>DS<span class="sc">$</span>logP_ACD[<span class="fu">which</span>(DS<span class="sc">$</span>ID <span class="sc">%in%</span> idxmiss)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a><span class="co"># data to model</span></span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a>datastruct_prior <span class="ot">=</span> <span class="fu">with</span>(DS,</span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">list</span>(<span class="at">logP=</span>DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)],</span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idxmissing=</span>idxmissing,</span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes=</span>nAnalytes,</span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nObs=</span>nObs,</span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a>                       <span class="at">analyte=</span>DS<span class="sc">$</span>ID,</span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logkObs=</span>DS<span class="sc">$</span>logk, </span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fi=</span>DS<span class="sc">$</span>concentration,</span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfiplot=</span><span class="fu">length</span>(fi),</span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fiplot=</span>fi,</span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_estimation=</span><span class="dv">0</span>))</span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>datastruct <span class="ot">=</span> <span class="fu">with</span>(DS,</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">list</span>(<span class="at">logP=</span>DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)],</span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idxmissing=</span>idxmissing,</span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes=</span>nAnalytes,</span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nObs=</span>nObs,</span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a>                       <span class="at">analyte=</span>DS<span class="sc">$</span>ID,</span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logkObs=</span>DS<span class="sc">$</span>logk, </span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fi=</span>DS<span class="sc">$</span>concentration,</span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfiplot=</span><span class="fu">length</span>(fi),</span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fiplot=</span>fi,</span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_estimation=</span><span class="dv">1</span>))</span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a><span class="co"># declaring initial values for each variable in chains</span></span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">logkwHat  =</span> <span class="fu">mean</span>(inital_param_A[,<span class="dv">2</span>]<span class="sc">+</span><span class="fu">rnorm</span>(nAnalytes,<span class="dv">0</span>,<span class="fl">0.5</span>)),</span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a>       <span class="at">logkaHat  =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a>       <span class="at">logS2AHat =</span> <span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_logka =</span> <span class="fl">0.4</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>),</span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a>       <span class="at">beta_logkw =</span> <span class="fl">0.8</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>),</span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>       <span class="at">eta=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(nAnalytes<span class="sc">*</span><span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),nAnalytes,<span class="dv">3</span>),</span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>       <span class="at">rho =</span> <span class="fu">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a>       <span class="at">nu =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="dv">10</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">2</span>)),</span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a>       <span class="at">omega=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.2</span>)),</span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>       <span class="at">sigmaadd =</span> <span class="fl">0.2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a><span class="co"># specifying parameters to analysis </span></span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a>parametersToPlot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"eta"</span>,<span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>)</span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a>otherRVs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"logkCond"</span>,<span class="st">"logkPred"</span>,<span class="st">"logkPlotACond"</span>,<span class="st">"logkPlotAPred"</span>,<span class="st">"log_lik"</span>,<span class="st">"log_likPred"</span>,</span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>              <span class="st">"eta"</span>,<span class="st">"etaPred"</span>)</span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a>parameters <span class="ot">&lt;-</span> <span class="fu">c</span>(parametersToPlot, otherRVs)</span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>parametersToPlot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"lp__"</span>, parametersToPlot)</span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting model</span></span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a>fit_prior <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">file=</span><span class="st">"HPLCizomodel44.stan"</span>,</span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a>            <span class="at">data=</span>datastruct_prior,</span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>            <span class="at">pars=</span>parameters,</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a>            <span class="at">iter=</span><span class="dv">2000</span>,</span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a>            <span class="at">warmup=</span><span class="dv">1000</span>,</span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a>            <span class="at">init=</span>init,</span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a>            <span class="at">chains=</span><span class="dv">4</span>,<span class="at">thin=</span><span class="dv">1</span>,<span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> <span class="fl">0.9</span>,<span class="at">max_treedepth=</span><span class="dv">15</span>))</span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">stan</span>(<span class="at">file=</span><span class="st">"ACN000.stan"</span>,</span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data=</span>datastruct,</span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>                   <span class="at">pars=</span>parameters,</span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a>                   <span class="at">iter=</span><span class="dv">2000</span>,</span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a>                   <span class="at">warmup=</span><span class="dv">1000</span>,</span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a>                   <span class="at">init=</span>init,</span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a>                   <span class="at">chains=</span><span class="dv">4</span>,<span class="at">thin=</span><span class="dv">1</span>,<span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_treedepth=</span><span class="dv">12</span>))</span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>Below code preapering data to fit the model in supercomputer:</span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE}</span></span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a><span class="fu">require</span>(gridExtra)</span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstan)</span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a><span class="co"># load data</span></span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a>DS       <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"1_data/database_stan_1026.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">dec =</span> <span class="st">"."</span>)</span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a>DS_names <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"1_data/database_stan_1026_analyte_names.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">dec =</span> <span class="st">"."</span>)</span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>DS_pKa   <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"1_data/ACD_pKas.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">dec =</span> <span class="st">"."</span>)</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>idxmissing <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>,<span class="dv">1026</span>)</span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>idxmiss <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.nan</span>(DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)]))</span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a>idxmissing[idxmiss] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a>DS<span class="sc">$</span>logP_ACD[<span class="fu">which</span>(DS<span class="sc">$</span>ID <span class="sc">%in%</span> idxmiss)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>logP<span class="ot">=</span>DS<span class="sc">$</span>logP_ACD[<span class="sc">!</span><span class="fu">duplicated</span>(DS<span class="sc">$</span>ID)]</span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a>nAnalytes<span class="ot">=</span><span class="fu">length</span>(<span class="fu">unique</span>(DS<span class="sc">$</span>ID))</span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>nObs<span class="ot">=</span><span class="fu">length</span>(DS<span class="sc">$</span>ID)</span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>analyte<span class="ot">=</span>DS<span class="sc">$</span>ID</span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>logkObs<span class="ot">=</span>DS<span class="sc">$</span>logk</span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>fi<span class="ot">=</span>DS<span class="sc">$</span>concentration</span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>fiplot<span class="ot">=</span><span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="fl">0.1</span>)</span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a>nfiplot<span class="ot">=</span><span class="fu">length</span>(fiplot)</span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>run_estimation<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a><span class="fu">stan_rdump</span>(<span class="fu">c</span>(<span class="st">"logP"</span>,</span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>             <span class="st">"nAnalytes"</span>, </span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a>             <span class="st">"nObs"</span>,</span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a>             <span class="st">"idxmissing"</span>, </span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a>             <span class="st">"analyte"</span>, </span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a>             <span class="st">"logkObs"</span>, </span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a>             <span class="st">"fi"</span>,</span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a>             <span class="st">"nfiplot"</span>,</span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a>             <span class="st">"fiplot"</span>,</span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a>             <span class="st">"run_estimation"</span>),</span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a>           <span class="at">file=</span><span class="st">"2_initial_model/model.data.R"</span>)</span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a>inital_param_A <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>,nAnalytes,<span class="dv">2</span>)</span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nAnalytes){</span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a>  inital_param_A[i,] <span class="ot">=</span> </span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a>    <span class="fu">polyfit</span>(DS<span class="sc">$</span>concentration[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]<span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>DS<span class="sc">$</span>concentration[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]),</span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a>            DS<span class="sc">$</span>logk[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)],<span class="dv">1</span>)</span>
<span id="cb18-295"><a href="#cb18-295" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a>  logkwHat  <span class="ot">=</span>  <span class="fu">mean</span>(inital_param_A[,<span class="dv">2</span>]<span class="sc">+</span><span class="fu">rnorm</span>(nAnalytes,<span class="dv">0</span>,<span class="fl">0.5</span>))</span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a>  logkaHat  <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a>  logS2AHat <span class="ot">=</span> <span class="fu">log</span>(<span class="dv">2</span>)<span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>)</span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a>  beta_logka <span class="ot">=</span> <span class="fl">0.4</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>)</span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a>  beta_logkw <span class="ot">=</span> <span class="fl">0.8</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.1</span>)</span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a>  eta<span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(nAnalytes<span class="sc">*</span><span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),nAnalytes,<span class="dv">3</span>)</span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a>  rho <span class="ot">=</span> <span class="fu">diag</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a>  nu <span class="ot">=</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="dv">10</span><span class="sc">+</span><span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">2</span>))</span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a>  omega<span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">3</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a>  sigmaadd <span class="ot">=</span> <span class="fl">0.2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.2</span>))</span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_rdump</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"eta"</span>,</span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a>               <span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>),</span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a>             <span class="at">file=</span><span class="fu">paste</span>(<span class="st">"2_initial_model/model_"</span>, i, <span class="st">".init.R"</span>, <span class="at">sep=</span><span class="st">""</span>))</span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-313"><a href="#cb18-313" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of model parameters</span></span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a>Code for print summary of parameters from supercomputer:</span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r eval=FALSE}</span></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as_cmdstan_fit</span>(<span class="fu">c</span>(<span class="st">'2_initial_model/output_1.csv'</span>,</span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_2.csv'</span>,</span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_3.csv'</span>,</span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_4.csv'</span>,</span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_5.csv'</span>,</span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_6.csv'</span>,</span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_7.csv'</span>,</span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_8.csv'</span>,</span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_9.csv'</span>,</span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">'2_initial_model/output_10.csv'</span>))</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span><span class="fu">print</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>), <span class="at">max_rows =</span> <span class="dv">26</span>)</span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a>Code for print summary of parameters from computer:</span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-338"><a href="#cb18-338" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"2_initial_model/Fit.Rsave"</span>)</span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"2_initial_model/Fit_sample.Rsave"</span>)</span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit,<span class="at">pars=</span><span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"logkaHat"</span>,<span class="st">"logS2AHat"</span>,<span class="st">"beta_logka"</span>,<span class="st">"beta_logkw"</span>,<span class="st">"rho"</span>,<span class="st">"nu"</span>,<span class="st">"omega"</span>,<span class="st">"sigmaadd"</span>))</span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a><span class="fu">## Goodness of fit</span></span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a>The graphs below were used to check how well the model fits the set of observations. The one on the left compares individual predictions with actual observations. The one on the right shows population predictions with actual observations.</span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb18-353"><a href="#cb18-353" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(fit_sample<span class="sc">$</span>logkCond,<span class="dv">2</span>,mean),DS<span class="sc">$</span>logk,<span class="at">cex.lab=</span><span class="fl">1.2</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>),<span class="at">pch=</span><span class="dv">20</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Obs]),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Pred]))</span>
<span id="cb18-354"><a href="#cb18-354" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">apply</span>(fit_sample<span class="sc">$</span>logkPred,<span class="dv">2</span>,mean),DS<span class="sc">$</span>logk,<span class="at">cex.lab=</span><span class="fl">1.2</span>,<span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>),<span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>,<span class="dv">3</span>),<span class="at">pch=</span><span class="dv">20</span>,<span class="at">col=</span><span class="st">"blue"</span>,<span class="at">ylab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Obs]),<span class="at">xlab=</span><span class="fu">expression</span>(<span class="st">"Log k"</span>[Pred]))</span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">6</span>,<span class="at">by=</span><span class="fl">0.1</span>),<span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a><span class="fu">### Analysis of eta's</span></span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a>Intra-analyte residues for analyte-specific parameters were also determined and are shown below.</span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-363"><a href="#cb18-363" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE}</span></span>
<span id="cb18-364"><a href="#cb18-364" aria-hidden="true" tabindex="-1"></a>eta_logka <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>eta[,,<span class="dv">1</span>]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> mean)</span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a>eta_logS2A <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>eta[,,<span class="dv">2</span>]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> mean)</span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a>eta_logkw <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>eta[,,<span class="dv">3</span>]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> mean)</span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a>DS_corr <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(eta_logka,eta_logS2A,eta_logkw))</span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-370"><a href="#cb18-370" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb18-371"><a href="#cb18-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a><span class="fu">ggpairs</span>(DS_corr, </span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span>  <span class="fu">c</span>(<span class="st">"eta_logkw"</span>,<span class="st">"eta_logka"</span>,<span class="st">"eta_logS2A"</span>),</span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower=</span><span class="fu">list</span>(<span class="at">continuous=</span><span class="st">'points'</span>), </span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a>        <span class="at">columnLabels =</span> <span class="fu">c</span>(<span class="st">"eta[ logk[w]]"</span>,<span class="st">"eta[ logk[a]]"</span>,<span class="st">"eta[ logS[2]]"</span>),</span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a>        <span class="at">labeller =</span> label_parsed,</span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a>        <span class="at">diag=</span><span class="fu">list</span>(<span class="at">continuous=</span><span class="fu">wrap</span>(<span class="st">"barDiag"</span>, <span class="at">fill=</span><span class="st">"darkblue"</span>))</span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a>)<span class="sc">+</span> <span class="fu">theme_grey</span>(<span class="at">base_size =</span> <span class="dv">15</span>)</span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a>The plot shows that the distribution of residuals in the case of the $\log k_a$ parameter is bimodal. It indicates that analytes with a similar log P are grouped into two clusters.</span>
<span id="cb18-382"><a href="#cb18-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-383"><a href="#cb18-383" aria-hidden="true" tabindex="-1"></a><span class="fu">### WAIC</span></span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a>WAIC was also used to evaluate the model. This parameter estimates the effective number of parameters to adjust for overfitting.</span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{r message=FALSE}</span></span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo)</span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a><span class="fu">waic</span>(<span class="fu">extract_log_lik</span>(fit)) <span class="co"># waic(fit_sample$log_lik)</span></span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(<span class="fu">extract_log_lik</span>(fit))</span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a><span class="fu">## Predictions</span></span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a>Individual predictions</span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a>nazwy <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Caffeine"</span>,<span class="st">"Chlorpropamide"</span>,<span class="st">"Doxepin hydrochloride"</span>,<span class="st">"Perphenazine"</span>,</span>
<span id="cb18-402"><a href="#cb18-402" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Pindolol"</span>,<span class="st">"Phenylbutazone"</span>,<span class="st">"Procainamide hydrochloride"</span>,<span class="st">"Retinoic acid"</span>,</span>
<span id="cb18-403"><a href="#cb18-403" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sulfaphenazole"</span>,<span class="st">"Tolbutamide"</span>,<span class="st">"Ketoprofen"</span>,<span class="st">"Indomethacin"</span>)</span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a>l_nazwy <span class="ot">&lt;-</span> <span class="fu">which</span>(DS_names<span class="sc">$</span>Analyte[<span class="sc">!</span><span class="fu">duplicated</span>(DS_names<span class="sc">$</span>ID)] <span class="sc">%in%</span> nazwy)</span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-406"><a href="#cb18-406" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-407"><a href="#cb18-407" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nAnalytes){</span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>logkPlotACond[,i,]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> quantile, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a>  logk_prct <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">rep</span>(i,<span class="dv">11</span>),fiplot,<span class="fu">t</span>(l)))</span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(logk_prct)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"ID"</span>,<span class="st">"concentration"</span>,<span class="st">"low"</span>,<span class="st">"median"</span>,<span class="st">"high"</span>)</span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a>  plots[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data=</span><span class="fu">subset</span>(DS, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> concentration, <span class="at">y =</span> logk), <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, <span class="at">y =</span> median), <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, </span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymin =</span> low, </span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymax =</span> high), <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">fill=</span><span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">4</span>)) <span class="sc">+</span> </span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(DS<span class="sc">$</span>Names[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]),</span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>), <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb18-422"><a href="#cb18-422" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)) </span>
<span id="cb18-423"><a href="#cb18-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-424"><a href="#cb18-424" aria-hidden="true" tabindex="-1"></a>figure1 <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(<span class="at">plotlist =</span> plots[l_nazwy], <span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb18-425"><a href="#cb18-425" aria-hidden="true" tabindex="-1"></a><span class="fu">annotate_figure</span>(figure1,</span>
<span id="cb18-426"><a href="#cb18-426" aria-hidden="true" tabindex="-1"></a>                <span class="at">bottom =</span> <span class="fu">text_grob</span>(<span class="fu">expression</span>(varphi)),</span>
<span id="cb18-427"><a href="#cb18-427" aria-hidden="true" tabindex="-1"></a>                <span class="at">left =</span> <span class="fu">text_grob</span>(<span class="st">"log k"</span>, <span class="at">rot =</span> <span class="dv">90</span>))</span>
<span id="cb18-428"><a href="#cb18-428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-429"><a href="#cb18-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-430"><a href="#cb18-430" aria-hidden="true" tabindex="-1"></a>Population predictions</span>
<span id="cb18-431"><a href="#cb18-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-434"><a href="#cb18-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-435"><a href="#cb18-435" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-436"><a href="#cb18-436" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nAnalytes){</span>
<span id="cb18-437"><a href="#cb18-437" aria-hidden="true" tabindex="-1"></a>  l <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">drop</span>(fit_sample<span class="sc">$</span>logkPlotAPred[,i,]), <span class="at">MARGIN =</span> <span class="dv">2</span>, <span class="at">FUN =</span> quantile, <span class="at">probs =</span> <span class="fu">c</span>(.<span class="dv">025</span>,.<span class="dv">5</span>,.<span class="dv">975</span>))</span>
<span id="cb18-438"><a href="#cb18-438" aria-hidden="true" tabindex="-1"></a>  logk_prct <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(<span class="fu">rep</span>(i,<span class="dv">11</span>),fiplot,<span class="fu">t</span>(l)))</span>
<span id="cb18-439"><a href="#cb18-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(logk_prct)<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"ID"</span>,<span class="st">"concentration"</span>,<span class="st">"low"</span>,<span class="st">"median"</span>,<span class="st">"high"</span>)</span>
<span id="cb18-440"><a href="#cb18-440" aria-hidden="true" tabindex="-1"></a>  plots[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span> <span class="fu">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb18-441"><a href="#cb18-441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data=</span><span class="fu">subset</span>(DS, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> concentration, <span class="at">y =</span> logk), <span class="at">col=</span><span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb18-442"><a href="#cb18-442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, <span class="at">y =</span> median), <span class="at">col=</span><span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb18-443"><a href="#cb18-443" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="at">data=</span><span class="fu">subset</span>(logk_prct, ID <span class="sc">==</span> i), <span class="fu">aes</span>(<span class="at">x =</span> fiplot, </span>
<span id="cb18-444"><a href="#cb18-444" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymin =</span> low, </span>
<span id="cb18-445"><a href="#cb18-445" aria-hidden="true" tabindex="-1"></a>                                                     <span class="at">ymax =</span> high), <span class="at">alpha =</span> <span class="fl">0.25</span>, <span class="at">fill=</span><span class="st">"red"</span>)<span class="sc">+</span></span>
<span id="cb18-446"><a href="#cb18-446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">4</span>)) <span class="sc">+</span> </span>
<span id="cb18-447"><a href="#cb18-447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(DS<span class="sc">$</span>Names[<span class="fu">which</span>(DS<span class="sc">$</span>ID<span class="sc">==</span>i)]),</span>
<span id="cb18-448"><a href="#cb18-448" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb18-449"><a href="#cb18-449" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb18-450"><a href="#cb18-450" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>), <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb18-451"><a href="#cb18-451" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"none"</span>, <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>)) </span>
<span id="cb18-452"><a href="#cb18-452" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-453"><a href="#cb18-453" aria-hidden="true" tabindex="-1"></a>figure1 <span class="ot">&lt;-</span> <span class="fu">ggarrange</span>(<span class="at">plotlist =</span> plots[l_nazwy], <span class="at">nrow=</span><span class="dv">3</span>,<span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb18-454"><a href="#cb18-454" aria-hidden="true" tabindex="-1"></a><span class="fu">annotate_figure</span>(figure1,</span>
<span id="cb18-455"><a href="#cb18-455" aria-hidden="true" tabindex="-1"></a>                <span class="at">bottom =</span> <span class="fu">text_grob</span>(<span class="fu">expression</span>(varphi)),</span>
<span id="cb18-456"><a href="#cb18-456" aria-hidden="true" tabindex="-1"></a>                <span class="at">left =</span> <span class="fu">text_grob</span>(<span class="st">"log k"</span>, <span class="at">rot =</span> <span class="dv">90</span>))</span>
<span id="cb18-457"><a href="#cb18-457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>